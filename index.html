<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>EDH RUMBLE TRACKER</title>
<style>
  body {
    margin:0;
    font-family:system-ui,Segoe UI,Roboto,sans-serif;
    background:#fafafa;
    color:#222;
  }
  header {
    text-align:center;
    padding:.5rem;
    font-weight:700;
    background:#ddd;
  }
  #contentArea {
    max-width:900px;
    margin:auto;
    padding:1rem;
  }
  button,input,textarea {
    font-family:inherit;
  }
  .accordion-block {
    border:1px solid #ccc;
    border-radius:.4rem;
    margin:.5rem 0;
  }
  .accordion-head {
    background:#eee;
    cursor:pointer;
    padding:.5rem .8rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:600;
  }
  .accordion-body {
    display:flex;
    flex-direction:column;
    gap:.5rem;
    padding:.5rem .8rem;
  }
  .lookup-row { display:flex; gap:.3rem; flex-wrap:wrap; }
  .lookup-input { flex:1; min-width:10rem; padding:.3rem; }
  .lookup-btn { padding:.3rem .6rem; cursor:pointer; }
  .lookup-preview-block {
    background:#f7f7f7;
    border-radius:.3rem;
    padding:.4rem;
  }
  .lookup-cardimg img { width:100%; max-width:250px; display:block; margin:auto; }
  .subsection-label { font-weight:600; margin-top:.5rem; }
  .hint { font-size:.75rem; color:#666; }
</style>
</head>
<body>
<header>EDH RUMBLE TRACKER</header>
<div id="contentArea">
  <div id="accordionsArea"></div>
</div>

<script>
/****************************************************
 * SMART SCRYFALL SEARCH ENGINE + LOOKUP HANDLERS
 * Version: Rumble Integration v2.0
 ****************************************************/
let players=[{dungeonProgress:"",emblemsText:""}];
let turnIndex=0;
let currentPlaneName="",currentSchemeName="",currentPlaneText="",currentSchemeText="",currentPlaneImg="",currentSchemeImg="";
let globalLookupInput,globalLookupText,globalLookupImg,globalLookupImgTag;
function renderAll(){renderAccordions();}

/* --- smart search core --- */
function getCardImage(c){
  if(c?.image_uris?.normal)return c.image_uris.normal;
  if(Array.isArray(c?.card_faces)){
    for(const f of c.card_faces)if(f.image_uris?.normal)return f.image_uris.normal;
  }
  return null;
}
async function scryfallSmartSearch(query,context){
  if(!query?.trim())return{error:"Enter a card name."};
  const base="https://api.scryfall.com";
  let url,filter;
  switch(context){
    case"dungeon":
      url=`${base}/cards/search?q=type%3ADungeon+${encodeURIComponent(query)}`;
      filter=c=>c.layout==="dungeon"||c.type_line.includes("Dungeon");
      break;
    case"emblem":
      url=`${base}/cards/search?q=layout%3Aemblem+${encodeURIComponent(query)}`;
      filter=c=>c.layout==="emblem";
      break;
    case"plane":
      url=`${base}/cards/search?q=(type%3APlane+OR+type%3APhenomenon)+${encodeURIComponent(query)}`;
      filter=c=>/Plane|Phenomenon/i.test(c.type_line);
      break;
    case"scheme":
      url=`${base}/cards/search?q=type%3AScheme+${encodeURIComponent(query)}`;
      filter=c=>/Scheme/i.test(c.type_line);
      break;
    default:
      url=`${base}/cards/named?fuzzy=${encodeURIComponent(query)}`;
  }
  try{
    let r=await fetch(url),d=await r.json();
    if(d.object==="error"||(Array.isArray(d.data)&&!d.data.length)){
      r=await fetch(`${base}/cards/named?fuzzy=${encodeURIComponent(query)}`);
      d=await r.json();
    }
    let card=Array.isArray(d.data)?d.data[0]:d;
    if(filter&&Array.isArray(d.data)){
      const fnd=d.data.find(filter);
      if(fnd)card=fnd;
    }
    if(!card||card.object==="error")return{error:`No ${context||"card"} found.`};
    return{preview:{name:card.name,type:card.type_line,text:card.oracle_text||"(No text)",image:getCardImage(card)}};
  }catch{return{error:"Search failed (offline?)"};}
}

/* --- per-context lookup functions --- */
function setPreviewError(p,f,msg){
  const m={dungeon:["dungeonPreviewText","dungeonPreviewImg"],emblem:["emblemPreviewText","emblemPreviewImg"]};
  if(m[f]){p[m[f][0]]=msg;p[m[f][1]]="";}
}

async function lookupDungeonForPlayer(i){
  const p=players[i],q=p.dungeonLookupName?.trim();
  if(!q)return setPreviewError(p,"dungeon","Enter a dungeon."),renderAll();
  const r=await scryfallSmartSearch(q,"dungeon");
  if(r.error)return setPreviewError(p,"dungeon",r.error),renderAll();
  const c=r.preview;
  p.dungeonPreviewText=`${c.name}\n${c.type}\n${c.text}`;
  p.dungeonPreviewImg=c.image||"";
  if(!p.dungeonProgress.toLowerCase().includes(c.name.toLowerCase()))
    p.dungeonProgress+=(p.dungeonProgress?"\n":"")+"Dungeon: "+c.name;
  renderAll();
}

async function lookupEmblemForPlayer(i){
  const p=players[i],q=p.emblemLookupName?.trim();
  if(!q)return setPreviewError(p,"emblem","Enter emblem."),renderAll();
  const r=await scryfallSmartSearch(q,"emblem");
  if(r.error)return setPreviewError(p,"emblem",r.error),renderAll();
  const c=r.preview;
  p.emblemPreviewText=`${c.name}\n${c.type}\n${c.text}`;
  p.emblemPreviewImg=c.image||"";
  if(!p.emblemsText.toLowerCase().includes(c.name.toLowerCase()))
    p.emblemsText+=(p.emblemsText?"\n":"")+`Emblem: ${c.name} — ${c.text}`;
  renderAll();
}

async function lookupPlaneGlobal(){
  if(!currentPlaneName?.trim())return(currentPlaneText="Enter plane name.",renderAll());
  const r=await scryfallSmartSearch(currentPlaneName,"plane");
  if(r.error)return(currentPlaneText=r.error,currentPlaneImg=""),renderAll();
  const c=r.preview;
  currentPlaneText=`${c.name}\n${c.type}\n${c.text}`;
  currentPlaneImg=c.image||"";renderAll();
}
async function lookupSchemeGlobal(){
  if(!currentSchemeName?.trim())return(currentSchemeText="Enter scheme name.",renderAll());
  const r=await scryfallSmartSearch(currentSchemeName,"scheme");
  if(r.error)return(currentSchemeText=r.error,currentSchemeImg=""),renderAll();
  const c=r.preview;
  currentSchemeText=`${c.name}\n${c.type}\n${c.text}`;
  currentSchemeImg=c.image||"";renderAll();
}

/* --- accordion rendering --- */
function makeToggleChip(label,state,onToggle){
  const b=document.createElement("button");
  b.textContent=label;
  b.style.padding=".2rem .5rem";
  b.style.borderRadius=".3rem";
  b.style.border="1px solid #aaa";
  b.style.background=state?"#6c9":"#fff";
  b.onclick=()=>onToggle(!state);
  return b;
}

function renderStatusAccordion(){
  const p=players[0];
  const wrap=document.createElement("div");
  wrap.className="accordion-block";
  const head=document.createElement("div");
  head.className="accordion-head";
  head.innerHTML='<div>Status Effects / Titles</div><div class="hint">Monarch, Initiative, Dungeons, Emblems, Plane, Scheme</div>';
  const body=document.createElement("div");
  body.className="accordion-body";

  const toggles=document.createElement("div");
  toggles.style.display="flex";toggles.style.gap=".3rem";
  toggles.append(
    makeToggleChip("Monarch",p.hasMonarch,v=>{p.hasMonarch=v;renderAll();}),
    makeToggleChip("Initiative",p.hasInitiative,v=>{p.hasInitiative=v;renderAll();}),
    makeToggleChip("Blessing",p.hasCitysBlessing,v=>{p.hasCitysBlessing=v;renderAll();})
  );

  // Dungeon
  const dLabel=document.createElement("div");
  dLabel.className="subsection-label";dLabel.textContent="Dungeon / Undercity";
  const dIn=document.createElement("input");dIn.className="lookup-input";dIn.placeholder="Lookup Dungeon…";
  dIn.value=p.dungeonLookupName||"";dIn.oninput=e=>p.dungeonLookupName=e.target.value;
  const dBtn=document.createElement("button");dBtn.className="lookup-btn";dBtn.textContent="Lookup";
  dBtn.onclick=()=>lookupDungeonForPlayer(0);
  const dPrev=document.createElement("div");dPrev.className="lookup-preview-block";
  dPrev.textContent=p.dungeonPreviewText||"";
  if(p.dungeonPreviewImg){const img=document.createElement("img");img.src=p.dungeonPreviewImg;img.style.width="200px";dPrev.append(img);}

  // Emblem
  const eLabel=document.createElement("div");
  eLabel.className="subsection-label";eLabel.textContent="Emblems / Globals";
  const eIn=document.createElement("input");eIn.className="lookup-input";eIn.placeholder="Lookup Emblem…";
  eIn.value=p.emblemLookupName||"";eIn.oninput=e=>p.emblemLookupName=e.target.value;
  const eBtn=document.createElement("button");eBtn.className="lookup-btn";eBtn.textContent="Lookup";
  eBtn.onclick=()=>lookupEmblemForPlayer(0);
  const ePrev=document.createElement("div");ePrev.className="lookup-preview-block";
  ePrev.textContent=p.emblemPreviewText||"";if(p.emblemPreviewImg){const img=document.createElement("img");img.src=p.emblemPreviewImg;img.style.width="200px";ePrev.append(img);}

  // Plane
  const pLabel=document.createElement("div");
  pLabel.className="subsection-label";pLabel.textContent="Current Plane";
  const pIn=document.createElement("input");pIn.className="lookup-input";pIn.placeholder="Current Plane…";pIn.value=currentPlaneName||"";pIn.oninput=e=>currentPlaneName=e.target.value;
  const pBtn=document.createElement("button");pBtn.className="lookup-btn";pBtn.textContent="Lookup";pBtn.onclick=lookupPlaneGlobal;
  const pPrev=document.createElement("div");pPrev.className="lookup-preview-block";pPrev.textContent=currentPlaneText||"";if(currentPlaneImg){const img=document.createElement("img");img.src=currentPlaneImg;img.style.width="200px";pPrev.append(img);}

  // Scheme
  const sLabel=document.createElement("div");
  sLabel.className="subsection-label";sLabel.textContent="Current Scheme";
  const sIn=document.createElement("input");sIn.className="lookup-input";sIn.placeholder="Current Scheme…";sIn.value=currentSchemeName||"";sIn.oninput=e=>currentSchemeName=e.target.value;
  const sBtn=document.createElement("button");sBtn.className="lookup-btn";sBtn.textContent="Lookup";sBtn.onclick=lookupSchemeGlobal;
  const sPrev=document.createElement("div");sPrev.className="lookup-preview-block";sPrev.textContent=currentSchemeText||"";if(currentSchemeImg){const img=document.createElement("img");img.src=currentSchemeImg;img.style.width="200px";sPrev.append(img);}

  body.append(toggles,dLabel,dIn,dBtn,dPrev,eLabel,eIn,eBtn,ePrev,pLabel,pIn,pBtn,pPrev,sLabel,sIn,sBtn,sPrev);
  wrap.append(head,body);
  return wrap;
}

function renderNotesAccordion(){
  const wrap=document.createElement("div");
  wrap.className="accordion-block";
  const head=document.createElement("div");
  head.className="accordion-head";
  head.innerHTML='<div>Notes / Reminders</div><div class="hint">Politics, goad, skip draw…</div>';
  const body=document.createElement("div");
  body.className="accordion-body";
  const t=document.createElement("textarea");t.rows=4;t.style.width="100%";t.placeholder="Write notes…";
  body.append(t);
  wrap.append(head,body);
  return wrap;
}

function renderAccordions(){
  const area=document.getElementById("accordionsArea");
  area.innerHTML="";
  area.append(renderStatusAccordion(),renderNotesAccordion());
}

renderAll();
</script>
</body>
</html>