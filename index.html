<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>EDH RUMBLE TRACKER v15</title>
<style>
/* =========================================================
   THEME VARIABLES
   ========================================================= */
:root {
  --bg-main:#ffffff;
  --bg-panel:#ffffff;
  --bg-accent:#f4f4fa;
  --border-soft:#bfbfd4;

  --text-primary:#1a1a22;
  --text-dim:#5a5a77;

  --gold:#9c7a1f;
  --cyan:#2a8f8f;
  --magenta:#b51882;
  --lime:#2a8f2a;
  --red:#a63f3f;
  --off:#8a8aa5;

  --button-bg:#ffffff;
  --button-border:#bfbfd4;

  --overlay-bg:rgba(0,0,0,0.6);

  --tool-bg:#ffffff;
  --tool-border:#bfbfd4;
}

.theme-dark {
  --bg-main:#0f0f12;
  --bg-panel:#1a1a22;
  --bg-accent:#2a2a36;
  --border-soft:#3a3a4f;

  --text-primary:#f5f5fa;
  --text-dim:#8a8aa5;

  --gold:#d4a94f;
  --cyan:#5fd8d8;
  --magenta:#ff4acb;
  --lime:#5fd85f;
  --red:#d85f5f;
  --off:#55556e;

  --button-bg:#2a2a36;
  --button-border:#3a3a4f;

  --overlay-bg:rgba(0,0,0,0.8);

  --tool-bg:#1a1a22;
  --tool-border:#3a3a4f;
}

.theme-neon {
  --bg-main:#050509;
  --bg-panel:#0e0e1a;
  --bg-accent:#1a1a33;
  --border-soft:#4a4aff;

  --text-primary:#ffeefe;
  --text-dim:#ff4aeb;

  --gold:#ffef5a;
  --cyan:#5fd8ff;
  --magenta:#ff4acb;
  --lime:#5CFFB6;
  --red:#ff4a6b;
  --off:#4f4f80;

  --button-bg:#1a1a33;
  --button-border:#4a4aff;

  --overlay-bg:rgba(0,0,30,0.8);

  --tool-bg:#0e0e1a;
  --tool-border:#4a4aff;
}

/* =========================================================
   BASE GLOBAL
   ========================================================= */
*{
  box-sizing:border-box;
  font-family:system-ui, Roboto, "Helvetica Neue", Arial, sans-serif;
}
body{
  margin:0;
  background:var(--bg-main);
  color:var(--text-primary);
  min-height:100vh;
  display:flex;
  justify-content:center;
}
button{
  cursor:pointer;
}
input, textarea, select, button {
  font-family:inherit;
  color:var(--text-primary);
  background:var(--bg-panel);
}

/* =========================================================
   APP SHELL / LAYOUT
   ========================================================= */
.app-shell{
  width:100%;
  max-width:480px;
  min-height:100vh;
  background:var(--bg-main);
  display:flex;
  flex-direction:column;
  position:relative;
  padding-bottom:3rem; /* keep space for bottom bar */
}

/* =========================================================
   TOP TURN REMINDER BAR (always visible, above header)
   ========================================================= */
.turn-reminder-bar{
  position:sticky;
  top:0;
  z-index:1500;
  background:var(--gold);
  color:#000;
  font-size:.75rem;
  font-weight:700;
  text-align:center;
  padding:.4rem .5rem;
  line-height:1.3;
  letter-spacing:.03em;
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
  justify-content:center;
}
#turnBanner{
  font-weight:700;
}
#respawnReminderInline{
  font-weight:600;
}

/* =========================================================
   HEADER (below reminder)
   ========================================================= */
.top-header{
  position:sticky;
  top:2rem; /* sits under turn-reminder-bar height */
  z-index:1000;
  background:var(--bg-panel);
  border-bottom:1px solid var(--border-soft);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:.6rem .75rem .5rem;
  gap:.4rem;
  box-shadow:0 12px 24px rgba(0,0,0,.12);
}
.header-row-1{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  align-items:center;
  gap:.5rem .75rem;
  width:100%;
}
.game-title{
  font-size:.8rem;
  font-weight:700;
  letter-spacing:.05em;
  color:var(--text-primary);
  text-align:center;
  flex:1;
  text-transform:uppercase;
}
.theme-toggle-wrap{
  display:flex;
  align-items:center;
  gap:.4rem;
  font-size:.7rem;
  font-weight:600;
  color:var(--text-dim);
}
.theme-select{
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.4rem .5rem;
  font-size:.7rem;
  font-weight:600;
  color:var(--text-primary);
}
.header-row-2{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  align-items:baseline;
  gap:.75rem 1rem;
  text-align:center;
  width:100%;
}
#globalTimerBanner{
  font-size:.75rem;
  font-weight:600;
  color:var(--text-primary);
  letter-spacing:.05em;
}

/* =========================================================
   SCROLLABLE MAIN CONTENT
   ========================================================= */
.content-area{
  flex:1;
  overflow-y:auto;
  padding:1rem .75rem 6rem; /* bottom room for bottom-sheet trigger */
  display:flex;
  flex-direction:column;
  gap:.75rem;
}

/* =========================================================
   HUD CARD (ACTIVE PLAYER PANEL)
   ========================================================= */
.hud-card{
  background:var(--bg-panel);
  border:2px solid var(--border-soft);
  border-radius:.75rem;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
  padding:.75rem;
  display:flex;
  flex-direction:column;
  gap:.75rem;
}
.hud-card.glow-border{
  box-shadow:0 0 20px rgba(0,0,0,.15),0 30px 60px rgba(0,0,0,.2);
}
.hud-top-row{
  display:flex;
  flex-wrap:wrap;
  gap:.75rem;
  justify-content:space-between;
}
.hud-col{
  flex:1 1 220px;
  min-width:0;
  display:flex;
  flex-direction:column;
  gap:.75rem;
}

/* section blocks */
.section-block-inline{
  background:var(--bg-accent);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.6rem .6rem .6rem;
  display:flex;
  flex-direction:column;
  gap:.6rem;
}

/* labels, inputs */
.label-sm{
  font-size:.6rem;
  font-weight:600;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
  line-height:1.2;
}
.text-input{
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  color:var(--text-primary);
  font-size:.8rem;
  line-height:1.3;
  padding:.5rem .6rem;
  min-width:5rem;
  font-weight:600;
  width:100%;
}
.text-input:focus{
  outline:2px solid var(--border-soft);
}

/* STATUS / COOLDOWN / TIMERS */
.tiny-row{
  display:flex;
  flex-wrap:wrap;
  align-items:flex-start;
  gap:.6rem .75rem;
  font-size:.7rem;
}
.status-chip{
  border-radius:.5rem;
  padding:.5rem .6rem;
  text-align:center;
  font-size:.7rem;
  font-weight:700;
  line-height:1.2;
  border:1px solid;
  cursor:pointer;
  min-width:5.5rem;
}
.status-active{
  color:var(--lime);
  border-color:var(--lime);
  background:rgba(44,255,44,.08);
}
.status-cooldown{
  color:var(--red);
  border-color:var(--red);
  background:rgba(255,44,44,.08);
}
.status-elim{
  color:var(--off);
  border-color:var(--off);
  background:rgba(85,85,110,.12);
}

.cd-info-inline{
  display:flex;
  flex-wrap:wrap;
  align-items:center;
  gap:.5rem .75rem;
}
.cd-label{
  font-size:.6rem;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
  line-height:1.2;
}
.cd-val-box{
  min-width:2rem;
  text-align:center;
  font-size:.8rem;
  font-weight:700;
  border:1px solid var(--border-soft);
  background:var(--bg-panel);
  border-radius:.5rem;
  padding:.4rem .5rem;
  line-height:1.2;
  color:var(--text-primary);
}

/* timers row */
.timer-row{
  display:flex;
  flex-wrap:wrap;
  gap:.75rem 1rem;
  font-size:.7rem;
  line-height:1.3;
}
.timer-block{
  display:flex;
  flex-direction:column;
  gap:.25rem;
}
.timer-label{
  font-size:.6rem;
  font-weight:500;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
}
.timer-val{
  font-size:clamp(.8rem,.6rem + .4vw,.9rem);
  font-weight:700;
  color:var(--gold);
  min-width:3.5rem;
}

/* commander tax */
.tax-row{
  display:flex;
  flex-wrap:wrap;
  align-items:flex-start;
  gap:.5rem .75rem;
  font-size:.7rem;
}
.tax-label{
  font-size:.6rem;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
  line-height:1.2;
}
.tax-ctrl{
  display:flex;
  align-items:center;
  gap:.5rem;
}
.tax-btn{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  font-size:.8rem;
  font-weight:700;
  line-height:1;
  padding:.45rem .65rem;
  min-width:2rem;
  text-align:center;
  color:var(--text-primary);
}
.tax-val{
  min-width:2.5rem;
  text-align:center;
  font-size:.9rem;
  font-weight:700;
  border:1px solid var(--border-soft);
  background:var(--bg-panel);
  border-radius:.5rem;
  padding:.4rem .6rem;
  color:var(--text-primary);
}

/* respawn reminder (big banner inside HUD) */
.respawn-draw-banner{
  background:rgba(212,169,79,.07);
  border:1px solid var(--gold);
  border-radius:.5rem;
  padding:.5rem .6rem;
  font-size:.7rem;
  font-weight:600;
  line-height:1.3;
  color:var(--gold);
}

/* LIFE + COUNTERS */
.vitalsBlock .life-row{
  display:flex;
  align-items:center;
  gap:.5rem;
  flex-wrap:wrap;
}
.life-btn{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  font-size:1rem;
  font-weight:700;
  line-height:1;
  padding:.5rem .7rem;
  min-width:2.2rem;
  text-align:center;
  color:var(--text-primary);
}
.life-value{
  min-width:3rem;
  text-align:center;
  font-size:1.2rem;
  font-weight:700;
  color:var(--text-primary);
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.5rem .7rem;
  line-height:1.2;
}

/* mini counters grid */
.mini-counters-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(min(160px,100%),1fr));
  gap:.75rem;
}
.sub-box{
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.6rem;
  display:flex;
  flex-direction:column;
  gap:.5rem;
}
.sub-box-label{
  font-size:.75rem;
  font-weight:600;
  color:var(--text-primary);
  display:flex;
  align-items:center;
  gap:.4rem;
}
.sub-box-step-row{
  display:flex;
  align-items:center;
  gap:.5rem;
  flex-wrap:wrap;
}
.step-btn{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  font-size:.9rem;
  font-weight:700;
  line-height:1;
  padding:.45rem .65rem;
  min-width:2.1rem;
  text-align:center;
  color:var(--text-primary);
}
.step-val{
  min-width:2.5rem;
  text-align:center;
  font-size:1rem;
  font-weight:700;
  border:1px solid var(--border-soft);
  background:var(--bg-panel);
  border-radius:.5rem;
  padding:.45rem .6rem;
  line-height:1.2;
  color:var(--text-primary);
}

/* =========================================================
   END TURN BUTTON
   ========================================================= */
.end-turn-btn{
  background:var(--gold);
  border:none;
  border-radius:.5rem;
  padding:.9rem .9rem;
  font-size:clamp(.8rem,.5rem + .5vw,.95rem);
  font-weight:700;
  color:#000;
  text-align:center;
  box-shadow:0 10px 20px rgba(0,0,0,.2);
  width:100%;
}

/* =========================================================
   TOOLS ACCORDION (collapsed by default)
   ========================================================= */
.section-frame{
  background:var(--bg-panel);
  border:2px solid var(--border-soft);
  border-radius:.75rem;
  box-shadow:0 20px 40px rgba(0,0,0,.12);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

.section-header-line{
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:.5rem;
  padding:.75rem;
  background:var(--bg-accent);
  border-bottom:1px solid var(--border-soft);
  cursor:pointer;
}
.section-header-title{
  font-size:.8rem;
  font-weight:700;
  color:var(--text-primary);
  text-transform:uppercase;
  letter-spacing:.05em;
}
.section-chevron{
  font-size:.8rem;
  color:var(--text-dim);
  font-weight:400;
}

.section-body{
  display:none;
  padding:.75rem;
  background:var(--bg-panel);
  font-size:.75rem;
  color:var(--text-primary);
  line-height:1.4;
  display:flex;
  flex-direction:column;
  gap:.75rem;
}

.tools-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(min(200px,100%),1fr));
  gap:.75rem;
}
.tool-block{
  background:var(--bg-accent);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.6rem;
  display:flex;
  flex-direction:column;
  gap:.6rem;
}
.tool-title{
  font-size:.65rem;
  font-weight:600;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
}

/* RANDOMIZERS */
.rng-row{
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
}
.rng-btn{
  flex:1;
  min-width:4rem;
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  color:var(--text-primary);
  font-size:.8rem;
  font-weight:600;
  padding:.6rem .75rem;
  text-align:center;
}
.rng-output{
  font-size:.8rem;
  font-weight:600;
  min-height:1em;
  line-height:1.2;
  color:var(--gold);
  word-break:break-word;
}

/* LOOKUP */
.lookup-col{
  flex:1;
  min-width:8rem;
  display:flex;
  flex-direction:column;
  gap:.5rem;
}
.lookup-input{
  width:100%;
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  color:var(--text-primary);
  font-size:.8rem;
  line-height:1.3;
  padding:.5rem .6rem;
  font-weight:600;
}
.lookup-btn{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  padding:.6rem .6rem;
  font-size:.7rem;
  font-weight:600;
  color:var(--text-primary);
  text-align:center;
  min-width:5rem;
}
.lookup-preview-block{
  display:flex;
  flex-wrap:wrap;
  gap:.75rem;
  font-size:.7rem;
  line-height:1.3;
  color:var(--text-primary);
}
.lookup-cardtext{
  flex:2;
  min-width:10rem;
  white-space:pre-line;
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.6rem .6rem;
}
.lookup-cardimg{
  flex:1;
  min-width:6rem;
  max-width:140px;
  border-radius:.5rem;
  border:1px solid var(--border-soft);
  background:var(--bg-panel);
  overflow:hidden;
  align-self:flex-start;
  display:none;
}
.lookup-cardimg img{
  width:100%;
  height:auto;
  display:block;
}

/* MODE / MINI BANNER */
.winner-mini-banner{
  border:1px solid var(--gold);
  color:var(--gold);
  background:var(--bg-panel);
  border-radius:.5rem;
  padding:.6rem .75rem;
  font-size:.8rem;
  font-weight:600;
  line-height:1.4;
  display:none;
  word-break:break-word;
}
.mode-line{
  font-size:.7rem;
  line-height:1.3;
  display:flex;
  flex-direction:column;
  gap:.5rem;
}
.mode-btn-row{
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
}
.mode-btn{
  flex:1;
  min-width:6rem;
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  padding:.6rem .75rem;
  font-size:.7rem;
  font-weight:600;
  color:var(--text-primary);
  text-align:center;
}

/* TABLE-STYLE NOTE ENTRY FOR ACTIVE POLITICS IS PER PLAYER DOWN BELOW.
   This tool section will *not* repeat a separate global notes textarea anymore. */

/* =========================================================
   OTHER PLAYERS ACCORDION (collapsed by default now)
   ========================================================= */
.other-player-block{
  background:var(--bg-accent);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  overflow:hidden;
}
.other-top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
  padding:.75rem .75rem;
  color:var(--text-primary);
  font-size:.8rem;
  font-weight:600;
}
.other-top-left{
  display:flex;
  flex-direction:column;
  line-height:1.3;
}
.other-top-name{
  font-size:.8rem;
  font-weight:600;
  color:var(--text-primary);
}
.other-top-subline{
  font-size:.7rem;
  color:var(--text-dim);
  display:flex;
  flex-wrap:wrap;
  gap:.5rem .75rem;
  align-items:center;
}
.other-chevron{
  font-size:.8rem;
  color:var(--text-dim);
  font-weight:400;
}

.other-body{
  display:none;
  padding:.75rem;
  border-top:1px solid var(--border-soft);
  font-size:.75rem;
  color:var(--text-primary);
  line-height:1.4;
  display:flex;
  flex-direction:column;
  gap:.75rem;
}

.inline-row-wrap{
  display:flex;
  flex-wrap:wrap;
  align-items:flex-start;
  gap:.75rem;
  font-size:.7rem;
}
.inline-col{
  display:flex;
  flex-direction:column;
  gap:.4rem;
  min-width:min(160px,100%);
  flex:1 1 160px;
}
.inline-col-label{
  font-size:.6rem;
  font-weight:600;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
}
.inline-life-row{
  display:flex;
  align-items:center;
  gap:.5rem;
  flex-wrap:wrap;
}
.inline-life-val{
  min-width:2.5rem;
  text-align:center;
  font-size:.9rem;
  font-weight:700;
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.4rem .6rem;
}

/* commander dmg grid */
.cdmg-wrap{
  display:flex;
  flex-direction:column;
  gap:.5rem;
}
.cdmg-head{
  font-size:.6rem;
  font-weight:600;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
  line-height:1.2;
}
.cdmg-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(min(140px,100%),1fr));
  gap:.5rem .75rem;
}
.cdmg-cell{
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.5rem;
  display:flex;
  flex-direction:column;
  gap:.4rem;
  font-size:.7rem;
}
.cdmg-cell-label{
  font-size:.65rem;
  color:var(--text-dim);
  line-height:1.2;
}
.cdmg-input-row input{
  width:3rem;
  text-align:center;
  background:var(--bg-accent);
  border:1px solid var(--border-soft);
  border-radius:.4rem;
  padding:.4rem .5rem;
  color:var(--text-primary);
  font-size:.8rem;
  font-weight:600;
}

/* player notes (politics, monarch, goad, etc.) */
.notes-area{
  background:var(--bg-accent);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.6rem .6rem;
  width:100%;
  min-height:3rem;
  resize:vertical;
  font-size:.75rem;
  line-height:1.3;
  color:var(--text-primary);
  font-weight:400;
}

/* =========================================================
   OVERLAYS (setup, announce, winner)
   ========================================================= */
.overlay-fullscreen{
  position:fixed;
  inset:0;
  background:var(--overlay-bg);
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:1rem;
}
.setup-card{
  background:var(--bg-panel);
  border:2px solid var(--border-soft);
  border-radius:.75rem;
  padding:1rem;
  max-width:320px;
  width:100%;
  display:flex;
  flex-direction:column;
  gap:1rem;
  text-align:center;
  box-shadow:0 30px 60px rgba(0,0,0,.4);
}
.setup-title{
  font-size:.9rem;
  font-weight:700;
  color:var(--text-primary);
  letter-spacing:.05em;
}
.setup-sub{
  font-size:.7rem;
  color:var(--text-dim);
  line-height:1.4;
}
.setup-row{
  display:flex;
  flex-wrap:wrap;
  gap:.5rem;
  justify-content:center;
}
.setup-btn{
  flex:1;
  min-width:6rem;
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  padding:.6rem .75rem;
  font-size:.8rem;
  font-weight:600;
  color:var(--text-primary);
  text-align:center;
}
.setup-small{
  display:flex;
  flex-direction:column;
  gap:.5rem;
  align-items:center;
  width:100%;
}
.label-block{
  font-size:.6rem;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:.05em;
  line-height:1.2;
  text-align:center;
  font-weight:600;
}
.setup-number-input{
  background:var(--bg-accent);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.5rem .6rem;
  font-size:.8rem;
  color:var(--text-primary);
  width:5rem;
  text-align:center;
}
.setup-go{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  padding:.6rem .75rem;
  font-size:.8rem;
  font-weight:600;
  color:var(--text-primary);
}
.helper-row{
  font-size:.65rem;
  color:var(--text-dim);
  line-height:1.3;
  text-align:center;
}

/* Winner overlay card */
.winner-card{
  background:var(--bg-panel);
  border:2px solid var(--gold);
  border-radius:1rem;
  padding:1rem;
  max-width:320px;
  width:100%;
  text-align:center;
  display:flex;
  flex-direction:column;
  gap:1rem;
  box-shadow:0 0 30px rgba(212,169,79,.4),0 40px 80px rgba(0,0,0,.8);
}
.winner-title{
  font-size:.9rem;
  font-weight:700;
  color:var(--gold);
  line-height:1.3;
  word-break:break-word;
}
.winner-line{
  font-size:.8rem;
  font-weight:500;
  color:var(--text-primary);
  line-height:1.4;
}
.overlay-btn{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  padding:.6rem .75rem;
  font-size:.8rem;
  font-weight:600;
  color:var(--text-primary);
  text-align:center;
}

/* Announce/cooldown modal */
.announce-card{
  background:var(--bg-panel);
  border:2px solid var(--gold);
  border-radius:1rem;
  padding:1rem;
  max-width:320px;
  width:100%;
  text-align:center;
  display:flex;
  flex-direction:column;
  gap:1rem;
  box-shadow:0 0 30px rgba(212,169,79,.4),0 40px 80px rgba(0,0,0,.8);
  font-size:.8rem;
  line-height:1.4;
  color:var(--text-primary);
}
.announce-strong{
  color:var(--gold);
  font-weight:700;
  font-size:.9rem;
  line-height:1.3;
}
.cooldown-ack-btn{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  padding:.6rem .75rem;
  font-size:.8rem;
  font-weight:600;
  color:var(--text-primary);
  text-align:center;
  width:100%;
}

/* =========================================================
   RUMBLE RULES BOTTOM SHEET
   ========================================================= */
.rules-bottom-bar{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  z-index:1200;
  background:var(--bg-panel);
  border-top:1px solid var(--border-soft);
  padding:.6rem .75rem;
  display:flex;
  justify-content:center;
  align-items:center;
  box-shadow:0 -10px 30px rgba(0,0,0,.3);
  font-size:.75rem;
  font-weight:700;
  color:var(--gold);
  letter-spacing:.05em;
  text-transform:uppercase;
  cursor:pointer;
  text-align:center;
  max-width:480px;
  margin:0 auto;
  border-top-left-radius:.75rem;
  border-top-right-radius:.75rem;
}

.rules-sheet-overlay{
  position:fixed;
  inset:0;
  background:var(--overlay-bg);
  z-index:2000;
  display:none;
  align-items:flex-end;
  justify-content:center;
  padding:0; /* we'll pad inside card */
}
.rules-sheet-card{
  background:var(--bg-panel);
  border-top:2px solid var(--gold);
  border-left:2px solid var(--border-soft);
  border-right:2px solid var(--border-soft);
  border-radius:1rem 1rem 0 0;
  width:100%;
  max-width:480px;
  max-height:70vh;
  display:flex;
  flex-direction:column;
  gap:.75rem;
  padding:.75rem;
  box-shadow:0 0 30px rgba(212,169,79,.4),0 -40px 80px rgba(0,0,0,.8);
  transform:translateY(100%);
  transition:transform .25s ease;
  color:var(--text-primary);
}
.rules-sheet-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:.5rem;
}
.rules-sheet-title{
  font-size:.8rem;
  font-weight:700;
  color:var(--gold);
  line-height:1.3;
  letter-spacing:.05em;
  text-transform:uppercase;
}
.rules-close-btn{
  background:var(--button-bg);
  border:1px solid var(--button-border);
  border-radius:.5rem;
  padding:.4rem .6rem;
  font-size:.7rem;
  font-weight:600;
  color:var(--text-primary);
}
.rules-scroll-block{
  flex:1;
  overflow-y:auto;
  font-size:.7rem;
  line-height:1.4;
  white-space:pre-line;
  background:var(--bg-panel);
  border:1px solid var(--border-soft);
  border-radius:.5rem;
  padding:.6rem .6rem;
  color:var(--text-primary);
}

/* When sheet is active, slide card up */
.rules-sheet-overlay.active .rules-sheet-card{
  transform:translateY(0%);
}
</style>
</head>
<body class="">
<div class="app-shell">

  <!-- ===========================
       SETUP OVERLAY
       =========================== -->
  <div id="setupOverlay" class="overlay-fullscreen">
    <!-- Step 1: choose mode -->
    <div class="setup-card" id="setupStepMode">
      <div class="setup-title">Select Mode</div>
      <div class="setup-row">
        <button class="setup-btn" data-mode="regular">
          Mode 1 — Regular
          <div class="setup-sub">Standard Commander. No respawn.</div>
        </button>
        <button class="setup-btn" data-mode="rumble">
          Mode 2 — Rumble
          <div class="setup-sub">Cooldown / Respawn / Reigning Rumbler.</div>
        </button>
      </div>
      <div class="helper-row">You’ll pick player count next.</div>
    </div>

    <!-- Step 2: player count -->
    <div class="setup-card" id="setupStepPlayers" style="display:none;">
      <div class="setup-title">How many players?</div>
      <div class="setup-row">
        <button class="setup-btn" data-fixedplayers="2">2</button>
        <button class="setup-btn" data-fixedplayers="3">3</button>
        <button class="setup-btn" data-fixedplayers="4">4</button>
      </div>
      <div class="setup-small">
        <div class="label-block">Manual Entry (2–8)</div>
        <input id="manualPlayerCount" class="setup-number-input" type="number" min="2" max="8" value="4" />
        <button id="manualStartBtn" class="setup-go">Start Game</button>
      </div>
      <div class="helper-row">You can rename yourself on your turn.</div>
    </div>
  </div>

  <!-- ===========================
       WINNER OVERLAY
       =========================== -->
  <div id="winnerOverlay" class="overlay-fullscreen" style="display:none;">
    <div class="winner-card">
      <div class="winner-title" id="winnerTitle">REIGNING RUMBLER!</div>
      <div class="winner-line" id="winnerTimeLine">Global Time: 00m 00s</div>
      <div class="winner-line" id="winnerPlayerTimeLine">Winner Player Time: 00m 00s</div>
      <button class="overlay-btn" id="winnerCloseBtn">OK</button>
    </div>
  </div>

  <!-- ===========================
       ANNOUNCE / COOLDOWN / RESPAWN POPUP
       =========================== -->
  <div id="announceOverlay" class="overlay-fullscreen" style="display:none;">
    <div class="announce-card">
      <div class="announce-strong" id="announceMain">Announcement</div>
      <div id="announceBody">Body text.</div>
      <button class="cooldown-ack-btn" id="announceOkBtn">OK</button>
    </div>
  </div>

  <!-- ===========================
       TURN REMINDER BAR
       =========================== -->
  <div class="turn-reminder-bar">
    <div id="turnBanner">▶ PLAYER 1'S TURN ◀</div>
    <div id="respawnReminderInline" style="display:none;">(Respawn turn: skip draw, draw 1 at end.)</div>
  </div>

  <!-- ===========================
       HEADER ROWS
       =========================== -->
  <div class="top-header">
    <div class="header-row-1">
      <div class="game-title">EDH RUMBLE TRACKER</div>
      <div class="theme-toggle-wrap">
        <label for="themeSelect" style="font-size:.7rem;">Theme</label>
        <select id="themeSelect" class="theme-select">
          <option value="" selected>Light</option>
          <option value="theme-dark">Dark</option>
          <option value="theme-neon">Neon</option>
        </select>
      </div>
    </div>
    <div class="header-row-2">
      <div id="globalTimerBanner">Global: 0:00</div>
    </div>
  </div>

  <!-- ===========================
       MAIN CONTENT
       =========================== -->
  <div class="content-area" id="contentArea">

    <!-- ACTIVE PLAYER HUD -->
    <div id="hudArea"></div>

    <!-- END TURN -->
    <button class="end-turn-btn" id="endTurnBtn">End Turn →</button>

    <!-- TOOLS ACCORDION -->
    <div id="toolsAccordion" class="section-frame">
      <div class="section-header-line" id="toolsHeader">
        <div class="section-header-title">TOOLS</div>
        <div class="section-chevron" id="toolsChevron">▲</div>
      </div>
      <div class="section-body" id="toolsBody" style="display:none;">
        <div class="tools-grid">

          <!-- CARD LOOKUP -->
          <div class="tool-block">
            <div class="tool-title">Card Lookup (Scryfall)</div>
            <div class="lookup-col">
              <input id="globalLookupInput" class="lookup-input" placeholder="Any card..." />
              <button id="globalLookupBtn" class="lookup-btn">Search</button>
            </div>

            <div class="lookup-preview-block">
              <div class="lookup-cardtext" id="globalLookupText"></div>
              <div class="lookup-cardimg" id="globalLookupImg">
                <img id="globalLookupImgTag" alt="card art"/>
              </div>
            </div>
          </div>

          <!-- RANDOMIZERS -->
          <div class="tool-block">
            <div class="tool-title">Randomizers</div>
            <div class="rng-row">
              <button class="rng-btn" id="flipCoinBtn">Coin Flip</button>
              <button class="rng-btn" id="rollD6Btn">d6</button>
              <button class="rng-btn" id="rollD20Btn">d20</button>
            </div>
            <div class="rng-output" id="rngOutput"></div>
          </div>

          <!-- GAME CONTROL -->
          <div class="tool-block">
            <div class="tool-title">Game Control</div>
            <div class="mode-line">
              <div id="modeStatusText">Mode 2 — Rumble</div>
              <div id="winnerMiniBanner" class="winner-mini-banner"></div>
              <div class="mode-btn-row">
                <button class="mode-btn" id="newGameBtn">New Game</button>
                <button class="mode-btn" id="changeModeBtn">Change Mode</button>
              </div>
            </div>
          </div>

        </div> <!-- /tools-grid -->
      </div>
    </div>

    <!-- OTHER PLAYERS ACCORDION -->
    <div id="othersAccordion" class="section-frame">
      <div class="section-header-line" id="othersHeader">
        <div class="section-header-title">OTHER PLAYERS</div>
        <div class="section-chevron" id="othersChevron">▲</div>
      </div>
      <div class="section-body" id="othersBody" style="display:none;"></div>
    </div>

  </div><!-- /content-area -->

  <!-- ===========================
       RUMBLE RULES BOTTOM BAR
       =========================== -->
  <div class="rules-bottom-bar" id="rulesBottomBar">
    RUMBLE RULES ⌃
  </div>

  <!-- ===========================
       RUMBLE RULES BOTTOM SHEET
       =========================== -->
  <div class="rules-sheet-overlay" id="rulesOverlay">
    <div class="rules-sheet-card">
      <div class="rules-sheet-header">
        <div class="rules-sheet-title">RUMBLE RULES</div>
        <button class="rules-close-btn" id="rulesCloseBtn">Close ✕</button>
      </div>
      <div class="rules-scroll-block" id="rulesBlock">
Rumble Rules

Setup:
• Commander decks: 100-card singleton, color identity applies.
• Everyone starts at 40 life, 0 poison.
• You can still lose forever if:
  – You take 21+ combat damage from one commander.
  – You try to draw and cannot (decked out).

Temporary Death (Cooldown):
You go on cooldown instead of leaving the game if:
  – Your life is 0 or less.
  – You have 10 or more poison counters.
  – An effect says "you lose the game."
"Win the game" effects do nothing in this format.
When you’re knocked out, you get a cooldown timer in turns.

Cooldown State:
While you're on cooldown:
  – You are not an active player.
  – You cannot cast spells, attack, block, activate abilities, or respond.
  – You can't be targeted as a player.
  – Your battlefield stays. Your stuff can still be attacked, removed, etc. You just can't defend it.
  – Your commander, hand, graveyard, etc. stay.
  – Triggers needing your choices are ignored. Triggers that don't need choices still work.

Cooldown Progress:
On each of your future turns (when play would rotate to you):
  1. If cooldown > 0, you're shown "You're cooling down." You acknowledge it. Then cooldown is reduced by 1, and play immediately passes on.
  2. If cooldown hits 0 after that tick, you immediately respawn and take a real turn.

Respawn:
When you respawn:
  – You become active again.
  – Your life becomes the ceiling of the average life total of all active players (not counting you).
  – You remove all poison counters.
  – Your commander tax resets.
  – You keep anything you still own on the battlefield.
  – You rejoin normal turn order.
Your first real turn back:
  – Skip your normal draw step.
  – Instead, draw 1 at END of that turn.

Reigning Rumbler:
If exactly one player is active and everyone else is cooling down or eliminated, that player becomes the Reigning Rumbler.
After that player finishes their NEXT full turn, if they are still the only active player, they win.

Regular Mode:
No cooldown or respawn. 0 life / 10 poison / "you lose the game" just eliminates you.
Last player standing wins.
      </div>
    </div>
  </div>

</div> <!-- /app-shell -->

<script>
/* =========================================================
   GLOBAL STATE
   ========================================================= */

let gameMode = null; // "regular" | "rumble"
let players = [];
let turnIndex = 0;          // whose turn index is currently acting / resolving
let turnCounter = 0;        // how many actual turns have completed
let gameStartTime = null;   // ms timestamp

// Reigning Rumbler tracking
let reigningCandidateIndex = null;
let reigningCandidateTurnStamp = null;

// Winner info
let winnerLocked = false;
let winnerName = "";
let winnerTimeMs = 0;
let winnerActiveMs = 0;

// Accordion open state
let toolsOpen = false;
let othersOpenAll = false;
let otherOpen = {}; // per-player expansion

// timers
let renderIntervalId = null;

// cooldown acknowledge flow
let showingAnnounce = false;
let pendingClearAfterAnnounce = null;

// DOM refs
const setupOverlay           = document.getElementById("setupOverlay");
const setupStepMode          = document.getElementById("setupStepMode");
const setupStepPlayers       = document.getElementById("setupStepPlayers");
const manualPlayerCount      = document.getElementById("manualPlayerCount");
const manualStartBtn         = document.getElementById("manualStartBtn");

const winnerOverlay          = document.getElementById("winnerOverlay");
const winnerTitle            = document.getElementById("winnerTitle");
const winnerTimeLine         = document.getElementById("winnerTimeLine");
const winnerPlayerTimeLine   = document.getElementById("winnerPlayerTimeLine");
const winnerCloseBtn         = document.getElementById("winnerCloseBtn");
const winnerMiniBanner       = document.getElementById("winnerMiniBanner");

const announceOverlay        = document.getElementById("announceOverlay");
const announceMain           = document.getElementById("announceMain");
const announceBody           = document.getElementById("announceBody");
const announceOkBtn          = document.getElementById("announceOkBtn");

const turnBanner             = document.getElementById("turnBanner");
const respawnReminderInline  = document.getElementById("respawnReminderInline");
const globalTimerBanner      = document.getElementById("globalTimerBanner");

const hudArea                = document.getElementById("hudArea");

const endTurnBtn             = document.getElementById("endTurnBtn");

const toolsAccordion         = document.getElementById("toolsAccordion");
const toolsHeader            = document.getElementById("toolsHeader");
const toolsChevron           = document.getElementById("toolsChevron");
const toolsBody              = document.getElementById("toolsBody");

const othersAccordion        = document.getElementById("othersAccordion");
const othersHeader           = document.getElementById("othersHeader");
const othersChevron          = document.getElementById("othersChevron");
const othersBody             = document.getElementById("othersBody");

const themeSelect            = document.getElementById("themeSelect");

const flipCoinBtn            = document.getElementById("flipCoinBtn");
const rollD6Btn              = document.getElementById("rollD6Btn");
const rollD20Btn             = document.getElementById("rollD20Btn");
const rngOutput              = document.getElementById("rngOutput");

const modeStatusText         = document.getElementById("modeStatusText");
const newGameBtn             = document.getElementById("newGameBtn");
const changeModeBtn          = document.getElementById("changeModeBtn");

const globalLookupInput      = document.getElementById("globalLookupInput");
const globalLookupBtn        = document.getElementById("globalLookupBtn");
const globalLookupText       = document.getElementById("globalLookupText");
const globalLookupImg        = document.getElementById("globalLookupImg");
const globalLookupImgTag     = document.getElementById("globalLookupImgTag");

/* Rumble Rules bottom sheet */
const rulesBottomBar         = document.getElementById("rulesBottomBar");
const rulesOverlay           = document.getElementById("rulesOverlay");
const rulesCloseBtn          = document.getElementById("rulesCloseBtn");

/* =========================================================
   UTILS
   ========================================================= */
function msToClock(ms){
  const totalSec = Math.floor(ms/1000);
  const mins = Math.floor(totalSec/60);
  const secs = totalSec % 60;
  return mins + ":" + (secs<10?("0"+secs):secs);
}
function formatDurationMs(ms){
  const totalSec = Math.floor(ms/1000);
  const mins = Math.floor(totalSec/60);
  const secs = totalSec % 60;
  return mins+"m "+secs+"s";
}
function getGameElapsedMs(){
  if(!gameStartTime) return 0;
  return Date.now()-gameStartTime;
}
function getAvgActiveLifeCeil(excludeIndex){
  let sum=0;
  let ct=0;
  players.forEach((pl,i)=>{
    if(i===excludeIndex) return;
    if(pl.status==="active"){
      sum+=pl.life;
      ct++;
    }
  });
  if(ct===0){ return 1; }
  return Math.ceil(sum/ct);
}
function getSeatColor(i){
  const cols=["var(--gold)","var(--cyan)","var(--magenta)","var(--lime)"];
  return cols[i % cols.length];
}

/* Player template */
function makePlayer(defaultName){
  return {
    name: defaultName,

    status:"active",          // "active"|"cooldown"|"eliminated"
    cooldownRemaining:0,

    life:40,
    poison:0,
    radiation:0,
    energy:0,
    experience:0,
    storm:0,

    notesText:"",

    commanderTaxSteps:0,

    commanderDamage:[], // victim.commanderDamage[srcIdx] = dmg

    totalActiveMs:0,
    turnStartMs:null,
    isTiming:false,

    pendingEOTDraw:false // after respawn, skip draw step, then draw 1 at end of first real turn
  };
}
function syncCommanderDamageArrays(){
  players.forEach(p=>{
    while(p.commanderDamage.length < players.length){
      p.commanderDamage.push(0);
    }
    if(p.commanderDamage.length > players.length){
      p.commanderDamage.length = players.length;
    }
  });
}

/* time tracking */
function startTimingPlayer(i){
  const p=players[i];
  if(!p || p.status!=="active") return;
  p.isTiming=true;
  p.turnStartMs=Date.now();
}
function stopTimingPlayer(i){
  const p=players[i];
  if(!p || !p.isTiming) return;
  const now=Date.now();
  const diff = now-(p.turnStartMs||now);
  p.totalActiveMs += diff;
  p.turnStartMs=null;
  p.isTiming=false;
}
function getPlayerTurnMs(p){
  if(p.isTiming && p.turnStartMs!=null){
    return Date.now()-p.turnStartMs;
  }
  return 0;
}
function getPlayerTotalMs(p){
  return p.totalActiveMs+getPlayerTurnMs(p);
}
function getActivePlayers(){
  const arr=[];
  players.forEach((pl,i)=>{
    if(pl.status==="active"){
      arr.push(i);
    }
  });
  return arr;
}

/* =========================================================
   OVERLAY HELPERS
   ========================================================= */
function showAnnounce(mainTxt, bodyTxt, acknowledgeCallback){
  showingAnnounce=true;
  announceMain.textContent = mainTxt;
  announceBody.textContent = bodyTxt;
  announceOverlay.style.display="flex";

  announceOkBtn.onclick = ()=>{
    announceOverlay.style.display="none";
    showingAnnounce=false;
    if(pendingClearAfterAnnounce!==null){
      const pp=players[pendingClearAfterAnnounce];
      if(pp){
        pp.pendingEOTDraw=false;
      }
      pendingClearAfterAnnounce=null;
    }
    if(typeof acknowledgeCallback==="function"){
      acknowledgeCallback();
    }
  };
}

/* =========================================================
   ELIM / COOLDOWN / RESPAWN LOGIC
   ========================================================= */
function permanentlyEliminate(i){
  const p=players[i];
  stopTimingPlayer(i);
  p.status="eliminated";
  p.cooldownRemaining=0;
  p.pendingEOTDraw=false;
  if(reigningCandidateIndex===i){
    reigningCandidateIndex=null;
    reigningCandidateTurnStamp=null;
  }
}

/* commander damage kill check */
function checkCommanderDamageElim(victimIdx){
  const p = players[victimIdx];
  for(let src=0; src<p.commanderDamage.length; src++){
    if(p.commanderDamage[src] >= 21){
      permanentlyEliminate(victimIdx);
      break;
    }
  }
}

/* Knockout to cooldown (or elim if regular) */
function knockOutToCooldown(i){
  const p=players[i];

  if(gameMode==="regular"){
    permanentlyEliminate(i);
    showAnnounce(
      (p.name||("Player "+(i+1)))+" eliminated",
      "Regular Mode: 0 life / 10 poison / lose-the-game is permanent.",
      null
    );
    return;
  }

  if(p.status==="eliminated") return;
  if(p.status==="cooldown") return;

  stopTimingPlayer(i);

  // cooldown start = 1 + how many others are already cooling
  let othersCooling=0;
  players.forEach((q,qi)=>{
    if(qi!==i && q.status==="cooldown") othersCooling++;
  });
  p.status="cooldown";
  p.cooldownRemaining=1+othersCooling;
  p.pendingEOTDraw=false;

  if(reigningCandidateIndex===i){
    reigningCandidateIndex=null;
    reigningCandidateTurnStamp=null;
  }

  showAnnounce(
    (p.name||("Player "+(i+1)))+" knocked out",
    "Entered cooldown for "+p.cooldownRemaining+" turn(s). On each of their turns, they acknowledge cooldown instead of playing.",
    null
  );
}

/* respawn now (called when cooldown hits 0 on their turn) */
function respawnPlayer(i){
  const p=players[i];
  if(p.status!=="cooldown") return;

  const newLife=getAvgActiveLifeCeil(i);
  p.status="active";
  p.cooldownRemaining=0;
  p.poison=0;
  p.life=newLife;
  p.commanderTaxSteps=0;
  p.pendingEOTDraw=true; // draw at end of first real turn back

  showAnnounce(
    (p.name||("Player "+(i+1)))+" respawned",
    "Life "+newLife+" (avg rounded up), poison = 0, commander tax reset.\nOn this first real turn back: skip normal draw step; instead draw 1 at END of this turn.",
    null
  );
}

/* lethal checks that cause cooldown or elim */
function lethalCheck(i,source){
  const p=players[i];
  if(!p) return;
  if(source==="life" && p.life<=0){
    knockOutToCooldown(i);
    return;
  }
  if(source==="poison" && p.poison>=10){
    knockOutToCooldown(i);
    return;
  }
}

/* Admin cycle status chip for active player in HUD */
function cycleStatusAdmin(i){
  const p=players[i];
  if(gameMode==="rumble"){
    // active -> cooldown -> eliminated -> active
    if(p.status==="active"){
      knockOutToCooldown(i);
    }else if(p.status==="cooldown"){
      permanentlyEliminate(i);
      showAnnounce(
        (p.name||("Player "+(i+1)))+" eliminated",
        "Manual correction.",
        null
      );
    }else{
      p.status="active";
      p.cooldownRemaining=0;
      p.pendingEOTDraw=false;
    }
  }else{
    // regular: active <-> eliminated
    if(p.status==="active"){
      permanentlyEliminate(i);
      showAnnounce(
        (p.name||("Player "+(i+1)))+" eliminated",
        "Manual correction.",
        null
      );
    }else{
      p.status="active";
      p.cooldownRemaining=0;
      p.pendingEOTDraw=false;
    }
  }
  renderAll();
}

/* =========================================================
   REIGNING RUMBLER / WIN LOGIC
   ========================================================= */
function updateReigningCandidateOnTurnEnd(){
  if(gameMode!=="rumble" || winnerLocked) return;
  const actives=getActivePlayers();
  if(actives.length===1){
    const onlyIdx=actives[0];
    if(reigningCandidateIndex!==onlyIdx){
      reigningCandidateIndex=onlyIdx;
      reigningCandidateTurnStamp=turnCounter;
      showAnnounce(
        (players[onlyIdx].name||("Player "+(onlyIdx+1)))+" is now REIGNING RUMBLER",
        "If they remain the only active player through their next full turn, they win.",
        null
      );
    }
  }else{
    reigningCandidateIndex=null;
    reigningCandidateTurnStamp=null;
  }
}

function checkReigningWin(){
  if(gameMode!=="rumble" || winnerLocked) return false;
  if(reigningCandidateIndex===null) return false;
  const actives=getActivePlayers();
  if(actives.length!==1) return false;
  const onlyIdx=actives[0];
  if(onlyIdx!==reigningCandidateIndex) return false;

  if(turnCounter>(reigningCandidateTurnStamp+1)){
    lockWinner(onlyIdx,true);
    return true;
  }
  return false;
}

function checkForWinRegular(){
  if(gameMode!=="regular" || winnerLocked) return false;
  const alive = players.filter(p=>p.status!=="eliminated");
  if(alive.length===1){
    const idx = players.indexOf(alive[0]);
    lockWinner(idx,false);
    return true;
  }
  return false;
}

function lockWinner(idx,isRumble){
  winnerLocked=true;
  winnerName = players[idx].name || ("Player "+(idx+1));
  winnerTimeMs = Date.now()-gameStartTime;
  winnerActiveMs = getPlayerTotalMs(players[idx]);

  if(isRumble){
    winnerTitle.textContent = winnerName.toUpperCase()+" — REIGNING RUMBLER!";
  } else {
    winnerTitle.textContent = winnerName+" wins the game!";
  }
  winnerTimeLine.textContent =
    "Global Time: "+formatDurationMs(winnerTimeMs);
  winnerPlayerTimeLine.textContent =
    "Winner Player Time: "+formatDurationMs(winnerActiveMs);

  winnerMiniBanner.style.display="block";
  winnerMiniBanner.textContent =
    winnerName+
    (isRumble? " — REIGNING RUMBLER! ":" wins!")+
    " ("+formatDurationMs(winnerTimeMs)+")";

  winnerOverlay.style.display="flex";
}

/* =========================================================
   TURN FLOW
   ========================================================= */

/*
Turn passing logic:

1. Stop current player's timer.
2. If they had pendingEOTDraw from respawn, show that reminder now.
3. We just ended a real turn -> turnCounter++.
4. Update reigning candidate, check win.
5. Move turnIndex clockwise.
6. Advance to a seat that takes a turn:
   - eliminated seats are skipped.
   - cooldown seats:
        show popup "cooling down."
        after acknowledge:
          cooldownRemaining -=1
          if >0: move on to next seat (do not turnCounter++)
          if ==0: respawnPlayer(i), that seat immediately becomes active and takes this turn
   - active seat:
        start timer, renderAll().
*/

function runEndOfTurnDrawIfNeeded(idx){
  const p=players[idx];
  if(!p) return;
  if(p.pendingEOTDraw){
    pendingClearAfterAnnounce = idx;
    showAnnounce(
      (p.name||("Player "+(idx+1)))+" draw reminder",
      "Draw 1 now (respawn recovery). You skipped normal draw step this turn.",
      function(){}
    );
  }
}

function rotateClockwiseIndex(i){
  if(players.length===0) return i;
  return (i+1)%players.length;
}

/* core seat advance */
function advanceTurnCore(){
  let safety=0;
  while(safety<50){
    safety++;

    const p=players[turnIndex];
    if(!p){
      turnIndex=rotateClockwiseIndex(turnIndex);
      continue;
    }

    // eliminated => skip
    if(p.status==="eliminated"){
      turnIndex=rotateClockwiseIndex(turnIndex);
      continue;
    }

    // cooldown seat
    if(p.status==="cooldown"){
      return handleCooldownSeat(turnIndex);
    }

    // active seat
    if(!winnerLocked){
      startTimingPlayer(turnIndex);
    }
    renderAll();
    return;
  }
  console.warn("advanceTurnCore safety stop");
  renderAll();
}

/* cooldown seat handler */
function handleCooldownSeat(i){
  const p = players[i];
  if(!p) {
    turnIndex=rotateClockwiseIndex(i);
    return advanceTurnCore();
  }

  if(p.cooldownRemaining>0){
    showAnnounce(
      (p.name||("Player "+(i+1)))+" is cooling down",
      "Cooldown remaining: "+p.cooldownRemaining+" turn(s). You do nothing this turn. Tap Acknowledge to continue.",
      function afterAck(){
        p.cooldownRemaining -=1;
        if(p.cooldownRemaining>0){
          // still cooling, skip to next seat
          turnIndex=rotateClockwiseIndex(i);
          return advanceTurnCore();
        }else{
          // cooldown hits 0 now -> respawn immediately and take THIS turn
          respawnPlayer(i);
          if(!winnerLocked){
            startTimingPlayer(i);
          }
          renderAll();
        }
      }
    );
    return;
  } else {
    // edge case: cooldownRemaining==0 but still flagged cooldown
    respawnPlayer(i);
    if(!winnerLocked){
      startTimingPlayer(i);
    }
    renderAll();
  }
}

/* main "End Turn" click */
function passTurn(){
  if(winnerLocked){
    renderAll();
    return;
  }

  // 1. stop timing current
  stopTimingPlayer(turnIndex);

  // 2. EOT draw reminder for respawn-turn players
  runEndOfTurnDrawIfNeeded(turnIndex);

  // 3. increment global turn counter
  turnCounter += 1;

  // 4. update reigning candidate/win in rumble
  if(gameMode==="rumble"){
    updateReigningCandidateOnTurnEnd();
  }

  // 5. Win checks (regular or reigning)
  if(gameMode==="regular"){
    if(checkForWinRegular()){
      renderAll();
      return;
    }
  }
  if(checkReigningWin()){
    renderAll();
    return;
  }

  // 6. rotate to next seat and resolve
  turnIndex = rotateClockwiseIndex(turnIndex);
  advanceTurnCore();
}

/* =========================================================
   SCRYFALL LOOKUP
   ========================================================= */
async function scryfallFuzzy(name){
  if(!name.trim()) return null;
  const url="https://api.scryfall.com/cards/named?fuzzy="+encodeURIComponent(name.trim());
  try{
    const resp=await fetch(url);
    if(!resp.ok) return null;
    return await resp.json();
  }catch(e){
    return null;
  }
}
function extractCardImage(data){
  if(!data) return "";
  if(data.image_uris && data.image_uris.normal){
    return data.image_uris.normal;
  }
  if(Array.isArray(data.card_faces)
   && data.card_faces[0]
   && data.card_faces[0].image_uris){
    return data.card_faces[0].image_uris.normal||"";
  }
  return "";
}
async function lookupAnyCardGlobal(){
  const rawName = globalLookupInput.value||"";
  const data = await scryfallFuzzy(rawName);
  if(!data){
    globalLookupText.textContent="Not found / offline.";
    globalLookupImg.style.display="none";
    globalLookupImgTag.removeAttribute("src");
    return;
  }
  const typeLine=data.type_line||"";
  const oracle=data.oracle_text||"";
  const nm=data.name||rawName.trim();

  globalLookupText.textContent = nm+
    (typeLine?("\n"+typeLine):"")+
    (oracle?("\n"+oracle):"");

  const imgUrl=extractCardImage(data);
  if(imgUrl){
    globalLookupImgTag.src=imgUrl;
    globalLookupImg.style.display="block";
  }else{
    globalLookupImg.style.display="none";
    globalLookupImgTag.removeAttribute("src");
  }
}

/* =========================================================
   RENDER HELPERS
   ========================================================= */
function renderGlobalTimerBanner(){
  globalTimerBanner.textContent = "Global: "+msToClock(getGameElapsedMs());
}
function renderTimersOnly(){
  renderGlobalTimerBanner();
  const p=players[turnIndex];
  if(p){
    const turnVal = document.querySelector(".timer-turn-val");
    const plVal   = document.querySelector(".timer-player-val");
    if(turnVal) turnVal.textContent = msToClock(getPlayerTurnMs(p));
    if(plVal)   plVal.textContent   = msToClock(getPlayerTotalMs(p));
  }
  // update each OTHER player's time chip
  players.forEach((pl,i)=>{
    if(i===turnIndex) return;
    const node=document.querySelector(`.player-time-val[data-idx="${i}"]`);
    if(node){
      node.textContent = msToClock(getPlayerTotalMs(pl));
    }
  });
}

/* build + render player HUD */
function renderHUD(){
  hudArea.innerHTML="";
  const p=players[turnIndex];
  if(!p) return;

  const seatColor=getSeatColor(turnIndex);

  const card=document.createElement("div");
  card.className="hud-card glow-border";
  card.style.borderColor=seatColor;
  card.style.boxShadow=
    `0 0 20px ${seatColor}66,0 30px 60px rgba(0,0,0,.35)`;

  const topRow=document.createElement("div");
  topRow.className="hud-top-row";

  /* LEFT COLUMN: name / status / timers / tax / respawn reminder */
  const leftCol=document.createElement("div");
  leftCol.className="hud-col";

  const nameBlock=document.createElement("div");
  nameBlock.className="section-block-inline";

  // Name
  const nmLabel=document.createElement("div");
  nmLabel.className="label-sm";
  nmLabel.textContent="Your Name";

  const nmInput=document.createElement("input");
  nmInput.className="text-input";
  nmInput.value=p.name;
  nmInput.addEventListener("input",e=>{
    p.name=e.target.value;
  });
  nmInput.addEventListener("blur",()=>{ renderAll(); });
  nmInput.addEventListener("keydown",ev=>{
    if(ev.key==="Enter"){
      ev.preventDefault();
      nmInput.blur();
    }
  });

  // Status chip + cooldown
  const statusWrap=document.createElement("div");
  statusWrap.className="tiny-row";

  const stChip=document.createElement("div");
  stChip.className="status-chip "+
    (p.status==="active"?"status-active":
     p.status==="cooldown"?"status-cooldown":
     "status-elim");
  stChip.textContent=
    p.status==="active"?"ACTIVE":
    p.status==="cooldown"?"COOLDOWN":
    "ELIMINATED";

  stChip.title = (gameMode==="rumble")
    ? "Tap to correct: Active ↔ Cooldown ↔ Eliminated"
    : "Tap to correct: Active ↔ Eliminated";
  stChip.addEventListener("click",()=>{
    cycleStatusAdmin(turnIndex);
  });

  statusWrap.appendChild(stChip);

  if(p.status==="cooldown" && gameMode==="rumble"){
    const cdDiv=document.createElement("div");
    cdDiv.className="cd-info-inline";

    const cdLab=document.createElement("div");
    cdLab.className="cd-label";
    cdLab.textContent="Cooldown:";

    const cdVal=document.createElement("div");
    cdVal.className="cd-val-box";
    cdVal.textContent=p.cooldownRemaining;

    cdDiv.appendChild(cdLab);
    cdDiv.appendChild(cdVal);
    statusWrap.appendChild(cdDiv);
  }

  // Timers
  const timeRow=document.createElement("div");
  timeRow.className="timer-row";

  const blockTurn=document.createElement("div");
  blockTurn.className="timer-block";
  const labTurn=document.createElement("div");
  labTurn.className="timer-label";
  labTurn.textContent="Turn Time";
  const valTurn=document.createElement("div");
  valTurn.className="timer-val timer-turn-val";
  valTurn.textContent=msToClock(getPlayerTurnMs(p));
  blockTurn.appendChild(labTurn);
  blockTurn.appendChild(valTurn);

  const blockPlayer=document.createElement("div");
  blockPlayer.className="timer-block";
  const labPlayer=document.createElement("div");
  labPlayer.className="timer-label";
  labPlayer.textContent="Player Time";
  const valPlayer=document.createElement("div");
  valPlayer.className="timer-val timer-player-val";
  valPlayer.textContent=msToClock(getPlayerTotalMs(p));
  blockPlayer.appendChild(labPlayer);
  blockPlayer.appendChild(valPlayer);

  timeRow.appendChild(blockTurn);
  timeRow.appendChild(blockPlayer);

  // Commander Tax
  const taxRow=document.createElement("div");
  taxRow.className="tax-row";

  const taxLabel=document.createElement("div");
  taxLabel.className="tax-label";
  taxLabel.textContent="Commander Tax: +2 ×";

  const taxCtrl=document.createElement("div");
  taxCtrl.className="tax-ctrl";

  const taxMinus=document.createElement("div");
  taxMinus.className="tax-btn";
  taxMinus.textContent="-";
  taxMinus.addEventListener("click",()=>{
    if(p.commanderTaxSteps>0)p.commanderTaxSteps--;
    renderAll();
  });
  const taxVal=document.createElement("div");
  taxVal.className="tax-val";
  taxVal.textContent=p.commanderTaxSteps;
  const taxPlus=document.createElement("div");
  taxPlus.className="tax-btn";
  taxPlus.textContent="+";
  taxPlus.addEventListener("click",()=>{
    p.commanderTaxSteps++;
    renderAll();
  });

  taxCtrl.appendChild(taxMinus);
  taxCtrl.appendChild(taxVal);
  taxCtrl.appendChild(taxPlus);

  taxRow.appendChild(taxLabel);
  taxRow.appendChild(taxCtrl);

  nameBlock.appendChild(nmLabel);
  nameBlock.appendChild(nmInput);
  nameBlock.appendChild(statusWrap);
  nameBlock.appendChild(timeRow);
  nameBlock.appendChild(taxRow);

  if(p.pendingEOTDraw){
    const reminder=document.createElement("div");
    reminder.className="respawn-draw-banner";
    reminder.textContent="Respawn Turn: Skip draw step. Draw 1 at END of this turn.";
    nameBlock.appendChild(reminder);
  }

  leftCol.appendChild(nameBlock);

  /* RIGHT COLUMN: Life + counters */
  const rightCol=document.createElement("div");
  rightCol.className="hud-col";

  const vitalsBlock=document.createElement("div");
  vitalsBlock.className="section-block-inline vitalsBlock";

  const lfLabel=document.createElement("div");
  lfLabel.className="label-sm";
  lfLabel.textContent="Life Total";

  const lfRow=document.createElement("div");
  lfRow.className="life-row";

  const minusBtn=document.createElement("div");
  minusBtn.className="life-btn";
  minusBtn.textContent="-";
  minusBtn.addEventListener("click",()=>{
    p.life = p.life-1;
    lethalCheck(turnIndex,"life");
    renderAll();
  });

  const lifeVal=document.createElement("div");
  lifeVal.className="life-value";
  lifeVal.textContent=p.life;

  const plusBtn=document.createElement("div");
  plusBtn.className="life-btn";
  plusBtn.textContent="+";
  plusBtn.addEventListener("click",()=>{
    p.life = p.life+1;
    renderAll();
  });

  lfRow.appendChild(minusBtn);
  lfRow.appendChild(lifeVal);
  lfRow.appendChild(plusBtn);

  const grid=document.createElement("div");
  grid.className="mini-counters-grid";

  grid.appendChild(makeSubStepper("☠ Poison",p.poison,val=>{
    p.poison=val;
    lethalCheck(turnIndex,"poison");
    renderAll();
  }));
  grid.appendChild(makeSubStepper("☢ Rad",p.radiation,val=>{
    p.radiation=val;
    renderAll();
  }));
  grid.appendChild(makeSubStepper("⚡ Energy",p.energy,val=>{
    p.energy=val;
    renderAll();
  }));
  grid.appendChild(makeSubStepper("★ Exp",p.experience,val=>{
    p.experience=val;
    renderAll();
  }));
  grid.appendChild(makeSubStepper("☁ Storm",p.storm,val=>{
    p.storm=val;
    renderAll();
  }));

  vitalsBlock.appendChild(lfLabel);
  vitalsBlock.appendChild(lfRow);
  vitalsBlock.appendChild(grid);

  rightCol.appendChild(vitalsBlock);

  topRow.appendChild(leftCol);
  topRow.appendChild(rightCol);
  card.appendChild(topRow);

  hudArea.appendChild(card);
}

function makeSubStepper(label,val,onSet){
  const box=document.createElement("div");
  box.className="sub-box";

  const l=document.createElement("div");
  l.className="sub-box-label";
  l.textContent=label;

  const row=document.createElement("div");
  row.className="sub-box-step-row";

  const minus=document.createElement("div");
  minus.className="step-btn";
  minus.textContent="-";
  minus.addEventListener("click",()=>{
    let v=val-1; if(v<0)v=0;
    onSet(v);
  });

  const mid=document.createElement("div");
  mid.className="step-val";
  mid.textContent=val;

  const plus=document.createElement("div");
  plus.className="step-btn";
  plus.textContent="+";
  plus.addEventListener("click",()=>{
    let v=val+1; if(v<0)v=0;
    onSet(v);
  });

  row.appendChild(minus);
  row.appendChild(mid);
  row.appendChild(plus);

  box.appendChild(l);
  box.appendChild(row);
  return box;
}

/* OTHER PLAYERS VIEW */
function renderOthers(){
  othersBody.innerHTML="";

  // top-level accordion body visibility
  othersChevron.textContent = othersOpenAll ? "▼" : "▲";
  othersBody.style.display = othersOpenAll ? "block":"none";

  players.forEach((pl,i)=>{
    if(i===turnIndex) return; // don't list current turn player as "Other" to themselves

    const block=document.createElement("div");
    block.className="other-player-block";
    block.setAttribute("data-idx",i);

    const top=document.createElement("div");
    top.className="other-top-row";

    const leftWrap=document.createElement("div");
    leftWrap.className="other-top-left";

    const nm=pl.name||("Player "+(i+1));
    const topName=document.createElement("div");
    topName.className="other-top-name";
    topName.textContent=nm;

    const subline=document.createElement("div");
    subline.className="other-top-subline";

    // status chunk
    let stChunk="Status: "+pl.status.toUpperCase();
    if(pl.status==="cooldown" && gameMode==="rumble"){
      stChunk+=" ("+pl.cooldownRemaining+")";
    }
    subline.appendChild(makeSubChunk(stChunk));

    // player time chunk
    const tChunk="Time ";
    const timeSpan=document.createElement("span");
    timeSpan.className="player-time-val";
    timeSpan.setAttribute("data-idx",i);
    timeSpan.textContent=msToClock(getPlayerTotalMs(pl));
    subline.appendChild(makeSubChunk(tChunk));
    subline.appendChild(timeSpan);

    leftWrap.appendChild(topName);
    leftWrap.appendChild(subline);

    const chev=document.createElement("div");
    chev.className="other-chevron";
    const isOpen=!!otherOpen[i];
    chev.textContent=isOpen?"▲":"▼";

    const body=document.createElement("div");
    body.className="other-body";
    body.style.display=isOpen?"flex":"none";

    // Vital edits
    const inlineVitals=document.createElement("div");
    inlineVitals.className="inline-row-wrap";

    const lifeCol=document.createElement("div");
    lifeCol.className="inline-col";
    const lifeLab=document.createElement("div");
    lifeLab.className="inline-col-label";
    lifeLab.textContent="Life Total ("+nm+")";

    const lifeRow=document.createElement("div");
    lifeRow.className="inline-life-row";

    const minusBtn=document.createElement("div");
    minusBtn.className="step-btn";
    minusBtn.textContent="-";
    minusBtn.addEventListener("click",()=>{
      pl.life=pl.life-1;
      lethalCheck(i,"life");
      renderAll();
    });

    const lifeVal=document.createElement("div");
    lifeVal.className="inline-life-val";
    lifeVal.textContent=pl.life;

    const plusBtn=document.createElement("div");
    plusBtn.className="step-btn";
    plusBtn.textContent="+";
    plusBtn.addEventListener("click",()=>{
      pl.life=pl.life+1;
      renderAll();
    });

    lifeRow.appendChild(minusBtn);
    lifeRow.appendChild(lifeVal);
    lifeRow.appendChild(plusBtn);
    lifeCol.appendChild(lifeLab);
    lifeCol.appendChild(lifeRow);

    const countersCol=document.createElement("div");
    countersCol.className="inline-col";
    const countersLab=document.createElement("div");
    countersLab.className="inline-col-label";
    countersLab.textContent="Counters ("+nm+")";
    const ctrRow=document.createElement("div");
    ctrRow.className="inline-row-wrap";

    ctrRow.appendChild(smallStepper("☠ Poison",pl.poison,(v)=>{
      pl.poison=v;
      lethalCheck(i,"poison");
      renderAll();
    }));
    ctrRow.appendChild(smallStepper("☢ Rad",pl.radiation,(v)=>{
      pl.radiation=v;
      renderAll();
    }));
    ctrRow.appendChild(smallStepper("★ Exp",pl.experience,(v)=>{
      pl.experience=v;
      renderAll();
    }));
    ctrRow.appendChild(smallStepper("☁ Storm",pl.storm,(v)=>{
      pl.storm=v;
      renderAll();
    }));

    countersCol.appendChild(countersLab);
    countersCol.appendChild(ctrRow);

    inlineVitals.appendChild(lifeCol);
    inlineVitals.appendChild(countersCol);
    body.appendChild(inlineVitals);

    // Commander damage grid
    const cdmg=document.createElement("div");
    cdmg.className="cdmg-wrap";

    const cdmgHead=document.createElement("div");
    cdmgHead.className="cdmg-head";
    cdmgHead.textContent="Commander Damage Taken by "+nm+" (21 from one source = elim)";
    cdmg.appendChild(cdmgHead);

    const cdmgGrid=document.createElement("div");
    cdmgGrid.className="cdmg-grid";

    players.forEach((srcPl,srcIdx)=>{
      const srcName=srcPl.name||("P"+(srcIdx+1));
      const cell=document.createElement("div");
      cell.className="cdmg-cell";

      const label=document.createElement("div");
      label.className="cdmg-cell-label";
      label.textContent="from "+srcName;
      const row=document.createElement("div");
      row.className="cdmg-input-row";

      const dmgIn=document.createElement("input");
      dmgIn.type="number";
      dmgIn.min="0";
      dmgIn.value=pl.commanderDamage[srcIdx]||0;
      dmgIn.addEventListener("input",e=>{
        let v=parseInt(e.target.value,10);
        if(isNaN(v)||v<0)v=0;
        pl.commanderDamage[srcIdx]=v;
        checkCommanderDamageElim(i);
        renderAll();
      });

      row.appendChild(dmgIn);
      cell.appendChild(label);
      cell.appendChild(row);
      cdmgGrid.appendChild(cell);
    });

    cdmg.appendChild(cdmgGrid);
    body.appendChild(cdmg);

    // politics / notes on that player
    const noteWrap=document.createElement("div");
    noteWrap.className="inline-col";
    const noteLab=document.createElement("div");
    noteLab.className="inline-col-label";
    noteLab.textContent="Notes on "+nm+" (Monarch, deals, goad, etc.)";

    const noteTa=document.createElement("textarea");
    noteTa.className="notes-area";
    noteTa.value=pl.notesText;
    noteTa.addEventListener("input",e=>{
      pl.notesText=e.target.value;
    });

    noteWrap.appendChild(noteLab);
    noteWrap.appendChild(noteTa);
    body.appendChild(noteWrap);

    // clicking header toggles
    top.addEventListener("click",()=>{
      otherOpen[i]=!otherOpen[i];
      renderOthers();
    });

    top.appendChild(leftWrap);

    const rightSide=document.createElement("div");
    rightSide.className="other-chevron";
    rightSide.textContent=isOpen?"▲":"▼";
    top.appendChild(rightSide);

    block.appendChild(top);
    block.appendChild(body);
    othersBody.appendChild(block);
  });
}

function makeSubChunk(text){
  const span=document.createElement("span");
  span.textContent=text;
  return span;
}

function smallStepper(labelText,val,onSet){
  const container=document.createElement("div");
  container.style.display="flex";
  container.style.flexDirection="column";
  container.style.gap=".4rem";
  container.style.minWidth="6rem";

  const lab=document.createElement("div");
  lab.style.fontSize=".7rem";
  lab.style.fontWeight="600";
  lab.style.color="var(--text-primary)";
  lab.textContent=labelText;

  const row=document.createElement("div");
  row.style.display="flex";
  row.style.flexWrap="wrap";
  row.style.gap=".4rem";
  row.style.alignItems="center";

  const minus=document.createElement("div");
  minus.className="step-btn";
  minus.textContent="-";
  minus.addEventListener("click",()=>{
    let v=val-1; if(v<0)v=0;
    onSet(v);
  });

  const mid=document.createElement("div");
  mid.className="step-val";
  mid.textContent=val;

  const plus=document.createElement("div");
  plus.className="step-btn";
  plus.textContent="+";
  plus.addEventListener("click",()=>{
    let v=val+1; if(v<0)v=0;
    onSet(v);
  });

  row.appendChild(minus);
  row.appendChild(mid);
  row.appendChild(plus);

  container.appendChild(lab);
  container.appendChild(row);
  return container;
}

/* =========================================================
   RENDER ALL
   ========================================================= */
function renderAll(){
  syncCommanderDamageArrays();

  const cur = players[turnIndex]||{};
  const nm  = cur.name||("Player "+(turnIndex+1));
  turnBanner.textContent = "▶ "+nm.toUpperCase()+"'S TURN ◀";

  // inline reminder if this player has pendingEOTDraw (respawn turn)
  if(cur.pendingEOTDraw){
    respawnReminderInline.style.display="inline";
  } else {
    respawnReminderInline.style.display="none";
  }

  modeStatusText.textContent =
    (gameMode==="regular"?"Mode 1 — Regular":"Mode 2 — Rumble");

  renderHUD();
  renderOthers();
  renderGlobalTimerBanner();

  if(winnerLocked){
    winnerMiniBanner.style.display="block";
  }else if(!winnerTimeMs){
    winnerMiniBanner.style.display="none";
  }
}

/* =========================================================
   SETUP / RESET
   ========================================================= */
function resetGameStateKeepMode(){
  players=[];
  turnIndex=0;
  turnCounter=0;

  reigningCandidateIndex=null;
  reigningCandidateTurnStamp=null;

  winnerLocked=false;
  winnerName="";
  winnerTimeMs=0;
  winnerActiveMs=0;

  otherOpen={};
  toolsOpen=false;
  othersOpenAll=false;

  if(renderIntervalId){
    clearInterval(renderIntervalId);
    renderIntervalId=null;
  }
}

function showModeStep(){
  resetGameStateKeepMode();
  gameMode=null;
  setupStepMode.style.display="flex";
  setupStepPlayers.style.display="none";
  setupOverlay.style.display="flex";
}

function showPlayerCountStep(){
  resetGameStateKeepMode();
  setupStepMode.style.display="none";
  setupStepPlayers.style.display="flex";
  setupOverlay.style.display="flex";
}

setupStepMode.querySelectorAll("[data-mode]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const m=btn.getAttribute("data-mode");
    gameMode = (m==="regular")?"regular":"rumble";
    showPlayerCountStep();
  });
});

setupStepPlayers.querySelectorAll("[data-fixedplayers]").forEach(btn=>{
  btn.addEventListener("click",()=>{
    const n=parseInt(btn.getAttribute("data-fixedplayers"),10);
    startGameWith(n);
  });
});

manualStartBtn.addEventListener("click",()=>{
  let n=parseInt(manualPlayerCount.value,10);
  if(isNaN(n)||n<2)n=2;
  if(n>8)n=8;
  startGameWith(n);
});

function startGameWith(nPlayers){
  players=[];
  for(let i=0;i<nPlayers;i++){
    players.push(makePlayer("Player "+(i+1)));
  }
  turnIndex=0;
  turnCounter=0;
  reigningCandidateIndex=null;
  reigningCandidateTurnStamp=null;
  winnerLocked=false;
  winnerName="";
  winnerTimeMs=0;
  winnerActiveMs=0;
  otherOpen={};
  toolsOpen=false;
  othersOpenAll=false;

  gameStartTime=Date.now();

  syncCommanderDamageArrays();

  setupOverlay.style.display="none";

  // start timer for first player if active
  if(players[0] && players[0].status==="active"){
    startTimingPlayer(0);
  }

  renderAll();

  // start render interval for timers
  if(renderIntervalId){
    clearInterval(renderIntervalId);
  }
  renderIntervalId=setInterval(()=>{
    if(!winnerLocked){
      renderTimersOnly();
    }
  },1000);
}

/* =========================================================
   EVENTS
   ========================================================= */
endTurnBtn.addEventListener("click",()=>{
  passTurn();
});

winnerCloseBtn.addEventListener("click",()=>{
  winnerOverlay.style.display="none";
});

/* TOOLS ACCORDION TOGGLE */
toolsHeader.addEventListener("click",()=>{
  toolsOpen = !toolsOpen;
  toolsBody.style.display = toolsOpen?"block":"none";
  toolsChevron.textContent = toolsOpen?"▼":"▲";
});

/* OTHERS ACCORDION TOGGLE */
othersHeader.addEventListener("click",()=>{
  othersOpenAll = !othersOpenAll;
  renderOthers();
});

/* THEME SELECT */
themeSelect.addEventListener("change",()=>{
  document.body.classList.remove("theme-dark","theme-neon");
  const val=themeSelect.value;
  if(val==="theme-dark"){
    document.body.classList.add("theme-dark");
  }else if(val==="theme-neon"){
    document.body.classList.add("theme-neon");
  }
});

/* RNG buttons */
flipCoinBtn.addEventListener("click",()=>{
  rngOutput.textContent="Coin: "+(Math.random()<0.5?"Heads":"Tails");
});
rollD6Btn.addEventListener("click",()=>{
  rngOutput.textContent="d6: "+(Math.floor(Math.random()*6)+1);
});
rollD20Btn.addEventListener("click",()=>{
  rngOutput.textContent="d20: "+(Math.floor(Math.random()*20)+1);
});

/* global card lookup */
globalLookupBtn.addEventListener("click",()=>{
  lookupAnyCardGlobal();
});

/* new / change mode */
newGameBtn.addEventListener("click",()=>{
  if(!confirm("Start a new game in the same mode? This clears all data.")) return;
  showPlayerCountStep();
});
changeModeBtn.addEventListener("click",()=>{
  if(!confirm("Change mode? This restarts the game.")) return;
  showModeStep();
});

/* RUMBLE RULES bottom sheet */
rulesBottomBar.addEventListener("click",()=>{
  rulesOverlay.style.display="flex";
  // force reflow so CSS transition applies
  void rulesOverlay.offsetWidth;
  rulesOverlay.classList.add("active");
});
rulesCloseBtn.addEventListener("click",closeRulesSheet);
rulesOverlay.addEventListener("click",(e)=>{
  // close if they clicked the darkened overlay area, not the card
  if(e.target===rulesOverlay){
    closeRulesSheet();
  }
});
function closeRulesSheet(){
  rulesOverlay.classList.remove("active");
  // wait for slide-down anim (~250ms) then hide
  setTimeout(()=>{ rulesOverlay.style.display="none"; },250);
}

/* =========================================================
   INIT
   ========================================================= */
showModeStep();
renderAll();
</script>
</body>
</html>